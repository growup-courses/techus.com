version: 2
jobs:
  build:
    working_directory: ~/repo
    docker:
      # specify the version you desire here
      - image: circleci/php:7.1.9-apache-node
      - image: circleci/mysql:5.7.22
      environment:
        - MYSQL_USER=root
        - MYSQL_PASSWORD=
        - MYSQL_ALLOW_EMPTY_PASSWORD=true
        - MYSQL_DATABASE=techus-test
        
        steps:
          - run:
            name: Install PHP extensions
            command: sudo docker-php-ext-install pdo_mysql
            - run:
              name: Install Composer
              command: 'curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer'
              - checkout
              
              # Download and cache dependencies
              - restore_cache:
                keys:
                  - v1-dependencies-{{ checksum "composer.json" }}
                  # fallback to using the latest cache if no exact match is found
                  - v1-dependencies-
                    
                    - run: composer install -n --prefer-dist
                    
                    - save_cache:
                      paths:
                        - ./vendor
                        key: v1-dependencies-{{ checksum "composer.json" }}
                        
                        # run tests!
                        - run: php vendor/bin/codecept run tests/api/
